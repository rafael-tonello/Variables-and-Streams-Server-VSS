//pseudo for vss replication protocol


//this functin is called with another vss instance sends a 'set var' pack
//if pack is new, it should be registered and retransmitted to all active pairs, otherwise ignored
OnReceivedSetVarPack(pack){
    if packIsNew(pack){
        memory.setVar(pack.payload.varName, pack.payload.value)

        registerPack(pack)
        reptransmitToPairs(pack)
    }
}

//this function checks if the pack is new by checking its id against processedPacks
//if the pack is new, registers it and returns true
registerPack(pack){
    processedPacks.push(pack.id)
    fi (processedPacks.length > maxProcessedPacks){
        processedPacks.shift() // Remove the oldest pack if limit exceeded
    }
}


//return true if pack is not present in the registered packs
packIsNew(pack){
    return !processedPacks.contains(pack.id)
}

//resend a pack to the pairs
//if the pair do not respond in time, consider it is disconnected and (if allowAutoRemoveDisconnectedPairs is true) 
// remove it from the pairsList
reptransmitToPairs(pack){
    for each pair in pairsList {
        if pair.isActive() {
            async((){
                reply=pair.sendPack(pack).waitReply
                if replay.error == "timeout" || reply.error= "disconnected" {
                    if (allowAutoRemoveDisconnectedPairs) {
                        pairsList.remove(pair)
                    }
                }
            });
        }
    }
}

//this function is called when another vss instance 'connects to this instance'
OnReceivedConnectPack(pack){
    if pairList.contains(pack.payload.pairId) {
        // If the pair is already connected, ignore the pack
        return
    }

    pairList.push(pack.payload.pairId)
}

//this function should be called when a connection to another vss instance should be established
ConnectToPair(pairId){
    pack = createNewPack()
    pack.type = "connect"
    pack.payload.pairId = pairId

    reply= sendPackToPair(pairInfo, pack).waitReply()
    if reply.isSuccess() {
        handleSuccessfulConnection(pairId)
        pairInfo = new Pair(pairId);
        pairList.push(pairInfo)
    fi
}